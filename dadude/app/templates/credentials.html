{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">üîê Archivio Credenziali</h1>
        <p class="text-muted mb-0">Credenziali centralizzate riutilizzabili tra clienti</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newCredentialModal">
        <i class="bi bi-plus"></i> Nuova Credenziale
    </button>
</div>

<!-- Filtri per tipo -->
<div class="mb-4">
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-secondary active" onclick="filterCredentials('all')">Tutte</button>
        <button type="button" class="btn btn-outline-primary" onclick="filterCredentials('ssh')">
            <i class="bi bi-terminal"></i> SSH
        </button>
        <button type="button" class="btn btn-outline-success" onclick="filterCredentials('snmp')">
            <i class="bi bi-broadcast"></i> SNMP
        </button>
        <button type="button" class="btn btn-outline-info" onclick="filterCredentials('wmi')">
            <i class="bi bi-windows"></i> WMI
        </button>
        <button type="button" class="btn btn-outline-warning" onclick="filterCredentials('mikrotik')">
            <i class="bi bi-router"></i> MikroTik
        </button>
    </div>
</div>

<!-- Lista credenziali -->
<div class="card">
    <div class="table-responsive">
        <table class="table table-hover mb-0" id="credentialsTable">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Username</th>
                    <th>Clienti</th>
                    <th>Device</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody id="credentialsBody">
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="spinner-border spinner-border-sm"></div> Caricamento...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nuova Credenziale -->
<div class="modal fade" id="newCredentialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-key"></i> Nuova Credenziale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="credentialForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome *</label>
                            <input type="text" class="form-control" name="name" required placeholder="es: Admin Linux Default">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo *</label>
                            <select class="form-select" name="credential_type" id="credType" onchange="toggleCredFields()" required>
                                <option value="ssh">SSH</option>
                                <option value="snmp">SNMP</option>
                                <option value="wmi">WMI (Windows)</option>
                                <option value="mikrotik">MikroTik API</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" placeholder="admin">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password">
                        </div>
                    </div>
                    
                    <!-- Campi SSH -->
                    <div id="sshFields">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Porta SSH</label>
                                <input type="number" class="form-control" name="ssh_port" value="22">
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Chiave Privata (opzionale)</label>
                                <textarea class="form-control" name="ssh_private_key" rows="2" placeholder="-----BEGIN RSA PRIVATE KEY-----"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi SNMP -->
                    <div id="snmpFields" style="display:none;">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Community</label>
                                <input type="text" class="form-control" name="snmp_community" value="public">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Versione</label>
                                <select class="form-select" name="snmp_version">
                                    <option value="2c">v2c</option>
                                    <option value="1">v1</option>
                                    <option value="3">v3</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Porta</label>
                                <input type="number" class="form-control" name="snmp_port" value="161">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi WMI -->
                    <div id="wmiFields" style="display:none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Dominio</label>
                                <input type="text" class="form-control" name="wmi_domain" placeholder="WORKGROUP">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Namespace</label>
                                <input type="text" class="form-control" name="wmi_namespace" value="root/cimv2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi MikroTik -->
                    <div id="mikrotikFields" style="display:none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Porta API</label>
                                <input type="number" class="form-control" name="mikrotik_api_port" value="8728">
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" name="mikrotik_api_ssl" id="useSsl">
                                    <label class="form-check-label" for="useSsl">Usa SSL (porta 8729)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">Descrizione</label>
                            <textarea class="form-control" name="description" rows="2" placeholder="Note opzionali..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i> Salva
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Assegna a Cliente -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-link"></i> Assegna a Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Credenziale: <strong id="assignCredName"></strong></p>
                
                <div class="mb-3">
                    <label class="form-label">Seleziona Cliente</label>
                    <select class="form-select" id="assignCustomer">
                        <option value="">Caricamento...</option>
                    </select>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="assignDefault">
                    <label class="form-check-label" for="assignDefault">
                        Imposta come default per questo tipo
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" onclick="confirmAssign()">
                    <i class="bi bi-link"></i> Assegna
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modifica Credenziale -->
<div class="modal fade" id="editCredentialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Modifica Credenziale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCredentialForm">
                <input type="hidden" name="credential_id" id="editCredId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome *</label>
                            <input type="text" class="form-control" name="name" id="editCredName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" name="credential_type" id="editCredType" onchange="toggleEditCredFields()" disabled>
                                <option value="ssh">SSH</option>
                                <option value="snmp">SNMP</option>
                                <option value="wmi">WMI (Windows)</option>
                                <option value="mikrotik">MikroTik API</option>
                            </select>
                            <small class="text-muted">Il tipo non pu√≤ essere modificato</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" id="editUsername">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password" id="editPassword" placeholder="Lascia vuoto per non modificare">
                        </div>
                    </div>
                    
                    <!-- Campi SSH -->
                    <div id="editSshFields">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Porta SSH</label>
                                <input type="number" class="form-control" name="ssh_port" id="editSshPort" value="22">
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Chiave Privata</label>
                                <textarea class="form-control" name="ssh_private_key" id="editSshKey" rows="2" placeholder="Lascia vuoto per non modificare"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi SNMP -->
                    <div id="editSnmpFields" style="display:none;">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Community</label>
                                <input type="text" class="form-control" name="snmp_community" id="editSnmpCommunity">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Versione</label>
                                <select class="form-select" name="snmp_version" id="editSnmpVersion">
                                    <option value="2c">v2c</option>
                                    <option value="1">v1</option>
                                    <option value="3">v3</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Porta</label>
                                <input type="number" class="form-control" name="snmp_port" id="editSnmpPort" value="161">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi WMI -->
                    <div id="editWmiFields" style="display:none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Dominio</label>
                                <input type="text" class="form-control" name="wmi_domain" id="editWmiDomain">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Namespace</label>
                                <input type="text" class="form-control" name="wmi_namespace" id="editWmiNamespace" value="root/cimv2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campi MikroTik -->
                    <div id="editMikrotikFields" style="display:none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Porta API</label>
                                <input type="number" class="form-control" name="mikrotik_api_port" id="editMtApiPort" value="8728">
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" name="mikrotik_api_ssl" id="editMtSsl">
                                    <label class="form-check-label" for="editMtSsl">Usa SSL</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">Descrizione</label>
                            <textarea class="form-control" name="description" id="editDescription" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i> Salva Modifiche
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Utilizzo -->
<div class="modal fade" id="usageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-diagram-3"></i> Utilizzo Credenziale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="usageBody">
                Caricamento...
            </div>
        </div>
    </div>
</div>

<script>
let allCredentials = [];
let allCustomers = [];
let currentCredentialId = null;

// Carica credenziali all'avvio
document.addEventListener('DOMContentLoaded', () => {
    loadCredentials();
    loadCustomers();
});

async function loadCredentials() {
    try {
        const response = await fetch('/api/v1/customers/credentials/all');
        const data = await response.json();
        allCredentials = data.credentials || [];
        renderCredentials();
    } catch (e) {
        console.error('Error loading credentials:', e);
        document.getElementById('credentialsBody').innerHTML = `
            <tr><td colspan="6" class="text-center text-danger">Errore caricamento</td></tr>
        `;
    }
}

async function loadCustomers() {
    try {
        const response = await fetch('/api/v1/customers/');
        const data = await response.json();
        allCustomers = data.customers || [];
        
        const select = document.getElementById('assignCustomer');
        select.innerHTML = allCustomers.map(c => 
            `<option value="${c.id}">${c.name} (${c.code})</option>`
        ).join('');
    } catch (e) {
        console.error('Error loading customers:', e);
    }
}

function renderCredentials() {
    const tbody = document.getElementById('credentialsBody');
    
    if (allCredentials.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                    <i class="bi bi-key display-6"></i>
                    <p class="mt-2">Nessuna credenziale configurata</p>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newCredentialModal">
                        <i class="bi bi-plus"></i> Crea prima credenziale
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = allCredentials.map(cred => {
        const typeBadge = {
            'ssh': '<span class="badge bg-primary"><i class="bi bi-terminal"></i> SSH</span>',
            'snmp': '<span class="badge bg-success"><i class="bi bi-broadcast"></i> SNMP</span>',
            'wmi': '<span class="badge bg-info"><i class="bi bi-windows"></i> WMI</span>',
            'mikrotik': '<span class="badge bg-warning text-dark"><i class="bi bi-router"></i> MikroTik</span>',
        }[cred.credential_type] || `<span class="badge bg-secondary">${cred.credential_type}</span>`;
        
        return `
            <tr data-type="${cred.credential_type}">
                <td>
                    <strong>${cred.name}</strong>
                    ${cred.description ? `<br><small class="text-muted">${cred.description}</small>` : ''}
                </td>
                <td>${typeBadge}</td>
                <td><code>${cred.username || '-'}</code></td>
                <td>
                    ${cred.customer_count > 0 
                        ? `<span class="badge bg-primary">${cred.customer_count}</span>` 
                        : '<span class="text-muted">0</span>'}
                </td>
                <td>
                    ${cred.device_count > 0 
                        ? `<span class="badge bg-secondary">${cred.device_count}</span>` 
                        : '<span class="text-muted">0</span>'}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editCredential('${cred.id}')" title="Modifica">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="showAssignModal('${cred.id}', '${cred.name}')" title="Assegna a Cliente">
                            <i class="bi bi-link"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="showUsage('${cred.id}')" title="Vedi utilizzo">
                            <i class="bi bi-diagram-3"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteCredential('${cred.id}')" title="Elimina">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function toggleCredFields() {
    const type = document.getElementById('credType').value;
    document.getElementById('sshFields').style.display = type === 'ssh' ? 'block' : 'none';
    document.getElementById('snmpFields').style.display = type === 'snmp' ? 'block' : 'none';
    document.getElementById('wmiFields').style.display = type === 'wmi' ? 'block' : 'none';
    document.getElementById('mikrotikFields').style.display = type === 'mikrotik' ? 'block' : 'none';
}

function filterCredentials(type) {
    const rows = document.querySelectorAll('#credentialsTable tbody tr');
    rows.forEach(row => {
        if (type === 'all' || row.dataset.type === type) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

document.getElementById('credentialForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // Converti checkbox
    data.mikrotik_api_ssl = document.getElementById('useSsl')?.checked || false;
    
    // Converti numeri
    if (data.ssh_port) data.ssh_port = parseInt(data.ssh_port);
    if (data.snmp_port) data.snmp_port = parseInt(data.snmp_port);
    if (data.mikrotik_api_port) data.mikrotik_api_port = parseInt(data.mikrotik_api_port);
    
    // Rimuovi campi vuoti
    Object.keys(data).forEach(k => { if (data[k] === '') delete data[k]; });
    
    // Credenziale globale
    data.is_global = true;
    
    const response = await fetch('/api/v1/customers/credentials', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    if (response.ok) {
        bootstrap.Modal.getInstance(document.getElementById('newCredentialModal')).hide();
        loadCredentials();
        e.target.reset();
    } else {
        const err = await response.json();
        alert('Errore: ' + (err.detail || 'Creazione fallita'));
    }
});

async function deleteCredential(id) {
    const cred = allCredentials.find(c => c.id === id);
    if (cred && cred.total_usage > 0) {
        if (!confirm(`Questa credenziale √® usata da ${cred.customer_count} clienti e ${cred.device_count} device.\nEliminarla comunque?`)) {
            return;
        }
    } else if (!confirm('Eliminare questa credenziale?')) {
        return;
    }
    
    const response = await fetch(`/api/v1/customers/credentials/${id}`, { method: 'DELETE' });
    if (response.ok) {
        loadCredentials();
    } else {
        alert('Errore durante l\'eliminazione');
    }
}

function showAssignModal(credId, credName) {
    currentCredentialId = credId;
    document.getElementById('assignCredName').textContent = credName;
    document.getElementById('assignDefault').checked = false;
    new bootstrap.Modal(document.getElementById('assignModal')).show();
}

async function confirmAssign() {
    const customerId = document.getElementById('assignCustomer').value;
    const isDefault = document.getElementById('assignDefault').checked;
    
    if (!customerId) {
        alert('Seleziona un cliente');
        return;
    }
    
    const response = await fetch(
        `/api/v1/customers/${customerId}/credential-links?credential_id=${currentCredentialId}&is_default=${isDefault}`,
        { method: 'POST' }
    );
    
    if (response.ok) {
        bootstrap.Modal.getInstance(document.getElementById('assignModal')).hide();
        loadCredentials();
        alert('‚úÖ Credenziale assegnata al cliente!');
    } else {
        const err = await response.json();
        alert('Errore: ' + (err.detail || 'Assegnazione fallita'));
    }
}

function toggleEditCredFields() {
    const type = document.getElementById('editCredType').value;
    document.getElementById('editSshFields').style.display = type === 'ssh' ? 'block' : 'none';
    document.getElementById('editSnmpFields').style.display = type === 'snmp' ? 'block' : 'none';
    document.getElementById('editWmiFields').style.display = type === 'wmi' ? 'block' : 'none';
    document.getElementById('editMikrotikFields').style.display = type === 'mikrotik' ? 'block' : 'none';
}

async function editCredential(credId) {
    try {
        const response = await fetch(`/api/v1/customers/credentials/${credId}`);
        if (!response.ok) throw new Error('Credenziale non trovata');
        
        const cred = await response.json();
        
        // Popola form
        document.getElementById('editCredId').value = cred.id;
        document.getElementById('editCredName').value = cred.name || '';
        document.getElementById('editCredType').value = cred.credential_type || 'ssh';
        document.getElementById('editUsername').value = cred.username || '';
        document.getElementById('editPassword').value = '';
        document.getElementById('editDescription').value = cred.description || '';
        
        // SSH
        document.getElementById('editSshPort').value = cred.ssh_port || 22;
        document.getElementById('editSshKey').value = '';
        
        // SNMP
        document.getElementById('editSnmpCommunity').value = cred.snmp_community || 'public';
        document.getElementById('editSnmpVersion').value = cred.snmp_version || '2c';
        document.getElementById('editSnmpPort').value = cred.snmp_port || 161;
        
        // WMI
        document.getElementById('editWmiDomain').value = cred.wmi_domain || '';
        document.getElementById('editWmiNamespace').value = cred.wmi_namespace || 'root/cimv2';
        
        // MikroTik
        document.getElementById('editMtApiPort').value = cred.mikrotik_api_port || 8728;
        document.getElementById('editMtSsl').checked = cred.mikrotik_api_ssl || false;
        
        toggleEditCredFields();
        new bootstrap.Modal(document.getElementById('editCredentialModal')).show();
        
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

document.getElementById('editCredentialForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const credId = document.getElementById('editCredId').value;
    const formData = new FormData(e.target);
    const data = {};
    
    // Prendi solo i campi con valore (escludi password vuota)
    for (const [key, value] of formData.entries()) {
        if (key === 'credential_id') continue;
        if (key === 'password' && value === '') continue;
        if (key === 'ssh_private_key' && value === '') continue;
        if (value !== '') data[key] = value;
    }
    
    // Converti numeri
    if (data.ssh_port) data.ssh_port = parseInt(data.ssh_port);
    if (data.snmp_port) data.snmp_port = parseInt(data.snmp_port);
    if (data.mikrotik_api_port) data.mikrotik_api_port = parseInt(data.mikrotik_api_port);
    
    // Checkbox
    data.mikrotik_api_ssl = document.getElementById('editMtSsl').checked;
    
    try {
        const response = await fetch(`/api/v1/customers/credentials/${credId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editCredentialModal')).hide();
            loadCredentials();
            alert('‚úÖ Credenziale aggiornata!');
        } else {
            const err = await response.json();
            alert('Errore: ' + (err.detail || JSON.stringify(err)));
        }
    } catch (e) {
        alert('Errore di connessione: ' + e.message);
    }
});

async function showUsage(credId) {
    currentCredentialId = credId;
    const cred = allCredentials.find(c => c.id === credId);
    
    document.getElementById('usageBody').innerHTML = 'Caricamento...';
    new bootstrap.Modal(document.getElementById('usageModal')).show();
    
    // Per ora mostriamo solo i conteggi
    // In futuro potremmo caricare la lista dettagliata dei clienti
    document.getElementById('usageBody').innerHTML = `
        <div class="text-center mb-3">
            <h4>${cred.name}</h4>
            <span class="badge bg-${cred.credential_type === 'ssh' ? 'primary' : cred.credential_type === 'snmp' ? 'success' : 'info'}">${cred.credential_type.toUpperCase()}</span>
        </div>
        
        <div class="row text-center">
            <div class="col-6">
                <div class="card bg-light">
                    <div class="card-body">
                        <h2 class="mb-0">${cred.customer_count}</h2>
                        <small class="text-muted">Clienti</small>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card bg-light">
                    <div class="card-body">
                        <h2 class="mb-0">${cred.device_count}</h2>
                        <small class="text-muted">Device</small>
                    </div>
                </div>
            </div>
        </div>
        
        ${cred.total_usage === 0 ? `
            <div class="alert alert-warning mt-3 mb-0">
                <i class="bi bi-exclamation-triangle"></i>
                Questa credenziale non √® ancora assegnata a nessun cliente o device.
            </div>
        ` : ''}
    `;
}
</script>
{% endblock %}
