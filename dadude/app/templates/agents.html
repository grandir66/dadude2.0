{% extends "base.html" %}

{% block title %}Gestione Agent - DaDude{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-robot"></i> Gestione Agent</h2>
        <button class="btn btn-outline-primary" onclick="loadAgents()">
            <i class="bi bi-arrow-clockwise"></i> Aggiorna
        </button>
    </div>

    <!-- Server Update Status -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-server"></i> Stato Server DaDude
            </h5>
            <div class="btn-group">
                <button class="btn btn-sm btn-light" onclick="checkServerUpdate()">
                    <i class="bi bi-cloud-arrow-down"></i> Verifica Aggiornamenti
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="server-status">
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-box-seam fs-2 me-3 text-primary"></i>
                            <div>
                                <small class="text-muted">Versione Server</small>
                                <h5 class="mb-0" id="server-version">Caricamento...</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-robot fs-2 me-3 text-info"></i>
                            <div>
                                <small class="text-muted">Versione Agent</small>
                                <h5 class="mb-0" id="agent-version">Caricamento...</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center" id="update-status-container" style="display: none;">
                            <i class="bi bi-arrow-up-circle-fill fs-2 me-3 text-success"></i>
                            <div>
                                <small class="text-muted">Aggiornamento Disponibile</small>
                                <h5 class="mb-0" id="latest-version">-</h5>
                                <button class="btn btn-sm btn-success mt-1" onclick="updateServer()">
                                    <i class="bi bi-download"></i> Aggiorna Server
                                </button>
                            </div>
                        </div>
                        <div id="up-to-date-container" style="display: none;">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-check-circle-fill fs-2 me-3 text-success"></i>
                                <div>
                                    <small class="text-muted">Stato</small>
                                    <h5 class="mb-0 text-success">Aggiornato</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent in attesa di approvazione -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="bi bi-hourglass-split"></i> Agent in Attesa di Approvazione
                <span id="pending-count" class="badge bg-dark ms-2">0</span>
            </h5>
        </div>
        <div class="card-body">
            <div id="pending-agents">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-search fs-1"></i>
                    <p class="mt-2">Caricamento...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Attivi -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="bi bi-check-circle"></i> Agent Attivi
                <span id="active-count" class="badge bg-light text-dark ms-2">0</span>
            </h5>
        </div>
        <div class="card-body">
            <div id="active-agents">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-search fs-1"></i>
                    <p class="mt-2">Caricamento...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Outdated -->
    <div class="card">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-arrow-up-circle"></i> Aggiornamenti Disponibili
                <span id="outdated-count" class="badge bg-light text-dark ms-2">0</span>
            </h5>
            <button class="btn btn-sm btn-light" onclick="updateAllAgents()" id="update-all-btn" style="display: none;">
                <i class="bi bi-download"></i> Aggiorna Tutti
            </button>
        </div>
        <div class="card-body">
            <div id="outdated-agents">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-lg fs-1"></i>
                    <p class="mt-2">Tutti gli agent sono aggiornati</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Approva Agent -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approva Agent</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Agent</label>
                    <input type="text" class="form-control" id="approve-agent-name" readonly>
                    <input type="hidden" id="approve-agent-id">
                </div>
                <div class="mb-3">
                    <label class="form-label">Indirizzo IP</label>
                    <input type="text" class="form-control" id="approve-agent-ip" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Assegna a Cliente *</label>
                    <select class="form-select" id="approve-customer-id" required>
                        <option value="">-- Seleziona Cliente --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-success" onclick="confirmApprove()">
                    <i class="bi bi-check-lg"></i> Approva
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let customers = [];

async function loadAgents() {
    await Promise.all([
        loadPendingAgents(),
        loadActiveAgents(),
        loadOutdatedAgents(),
        loadCustomers()
    ]);
}

async function loadCustomers() {
    try {
        const response = await fetch('/api/v1/customers');
        if (response.ok) {
            const data = await response.json();
            customers = data.customers || data;
            
            // Popola dropdown
            const select = document.getElementById('approve-customer-id');
            select.innerHTML = '<option value="">-- Seleziona Cliente --</option>';
            customers.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }
    } catch (e) {
        console.error('Error loading customers:', e);
    }
}

async function loadPendingAgents() {
    const container = document.getElementById('pending-agents');
    
    try {
        const response = await fetch('/api/v1/agents/pending');
        if (!response.ok) throw new Error('Failed to load pending agents');
        
        const data = await response.json();
        document.getElementById('pending-count').textContent = data.total;
        
        if (data.total === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-circle fs-1"></i>
                    <p class="mt-2">Nessun agent in attesa di approvazione</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Indirizzo</th>
                        <th>Tipo</th>
                        <th>Versione</th>
                        <th>Registrato</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.agents.map(a => `
                        <tr>
                            <td><strong>${a.name}</strong></td>
                            <td><code>${a.address}</code></td>
                            <td><span class="badge bg-secondary">${a.agent_type || 'docker'}</span></td>
                            <td>${a.version || 'N/A'}</td>
                            <td>${a.created_at ? new Date(a.created_at).toLocaleString() : 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="showApproveModal('${a.id}', '${a.name}', '${a.address}')">
                                    <i class="bi bi-check-lg"></i> Approva
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="rejectAgent('${a.id}')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
    } catch (e) {
        container.innerHTML = `
            <div class="alert alert-danger">
                Errore nel caricamento: ${e.message}
            </div>
        `;
    }
}

async function loadActiveAgents() {
    const container = document.getElementById('active-agents');
    
    try {
        // Carica tutti gli agent assegnati dai clienti
        const response = await fetch('/api/v1/customers');
        if (!response.ok) throw new Error('Failed to load customers');
        
        const data = await response.json();
        const customers = data.customers || data; // Supporta entrambi i formati
        let allAgents = [];
        
        for (const customer of customers) {
            const agentsResp = await fetch(`/api/v1/customers/${customer.id}/agents`);
            if (agentsResp.ok) {
                const agents = await agentsResp.json();
                agents.forEach(a => {
                    allAgents.push({...a, customer_name: customer.name, customer_id: customer.id});
                });
            }
        }
        
        document.getElementById('active-count').textContent = allAgents.length;
        
        if (allAgents.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-robot fs-1"></i>
                    <p class="mt-2">Nessun agent attivo</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Cliente</th>
                        <th>Indirizzo</th>
                        <th>Tipo</th>
                        <th>Stato</th>
                        <th>Versione</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    ${allAgents.map(a => `
                        <tr>
                            <td><strong>${a.name}</strong></td>
                            <td><a href="/customers/${a.customer_id}">${a.customer_name}</a></td>
                            <td><code>${a.address}</code></td>
                            <td><span class="badge ${a.agent_type === 'docker' ? 'bg-info' : 'bg-primary'}">${a.agent_type || 'mikrotik'}</span></td>
                            <td>
                                <span class="badge ${a.active ? 'bg-success' : 'bg-secondary'}">
                                    ${a.active ? 'Attivo' : 'Inattivo'}
                                </span>
                            </td>
                            <td>${a.version || 'N/A'}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="testAgent('${a.id}', '${a.address}', ${a.agent_api_port || 8080})" title="Test connessione">
                                        <i class="bi bi-broadcast"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="verifyAgentVersion('${a.id}', '${a.name}')" title="Verifica versione">
                                        <i class="bi bi-search"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="restartAgent('${a.id}')" title="Riavvia">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
    } catch (e) {
        container.innerHTML = `
            <div class="alert alert-danger">
                Errore nel caricamento: ${e.message}
            </div>
        `;
    }
}

async function loadOutdatedAgents() {
    const container = document.getElementById('outdated-agents');
    
    try {
        const response = await fetch('/api/v1/agents/outdated');
        if (!response.ok) throw new Error('Failed to load outdated agents');
        
        const data = await response.json();
        document.getElementById('outdated-count').textContent = data.outdated_count;
        
        if (data.outdated_count === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-lg fs-1"></i>
                    <p class="mt-2">Tutti gli agent sono aggiornati (v${data.latest_version})</p>
                </div>
            `;
            document.getElementById('update-all-btn').style.display = 'none';
            return;
        }
        
        document.getElementById('update-all-btn').style.display = 'block';
        
        container.innerHTML = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Indirizzo</th>
                        <th>Versione Attuale</th>
                        <th>Versione Disponibile</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.outdated_agents.map(a => `
                        <tr>
                            <td><strong>${a.name}</strong></td>
                            <td><code>${a.address}</code></td>
                            <td><span class="badge bg-warning text-dark">${a.current_version}</span></td>
                            <td><span class="badge bg-success">${a.latest_version}</span></td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-primary" onclick="updateAgent('${a.id}')">
                                        <i class="bi bi-download"></i> Aggiorna
                                    </button>
                                    <button class="btn btn-info" onclick="verifyAgentVersion('${a.id}', '${a.name}')" title="Verifica versione dopo update">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
    } catch (e) {
        container.innerHTML = `
            <div class="alert alert-danger">
                Errore nel caricamento: ${e.message}
            </div>
        `;
    }
}

function showApproveModal(agentId, agentName, agentIp) {
    document.getElementById('approve-agent-id').value = agentId;
    document.getElementById('approve-agent-name').value = agentName;
    document.getElementById('approve-agent-ip').value = agentIp;
    
    new bootstrap.Modal(document.getElementById('approveModal')).show();
}

async function confirmApprove() {
    const agentId = document.getElementById('approve-agent-id').value;
    const customerId = document.getElementById('approve-customer-id').value;
    
    if (!customerId) {
        alert('Seleziona un cliente');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/agents/${agentId}/approve?customer_id=${customerId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('approveModal')).hide();
            alert('Agent approvato con successo!');
            loadAgents();
        } else {
            const data = await response.json();
            alert('Errore: ' + (data.detail || 'Approvazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function rejectAgent(agentId) {
    if (!confirm('Eliminare questo agent in attesa?')) return;
    
    try {
        const response = await fetch(`/api/v1/customers/agents/${agentId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadAgents();
        } else {
            alert('Errore nella cancellazione');
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function testAgent(agentId, address, port) {
    try {
        const response = await fetch(`http://${address}:${port}/health`, {
            mode: 'cors',
            headers: { 'Accept': 'application/json' }
        });
        
        if (response.ok) {
            const data = await response.json();
            alert(`âœ… Agent OK\n\nID: ${data.agent_id}\nNome: ${data.agent_name}\nVersione: ${data.version}`);
        } else {
            alert('âŒ Agent non raggiungibile');
        }
    } catch (e) {
        alert('âŒ Errore: ' + e.message);
    }
}

async function restartAgent(agentId) {
    if (!confirm('Riavviare questo agent?')) return;
    
    try {
        const response = await fetch(`/api/v1/agents/${agentId}/restart`, {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('Comando di riavvio inviato');
        } else {
            alert('Errore nell\'invio del comando');
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function updateAgent(agentId) {
    try {
        const response = await fetch(`/api/v1/agents/${agentId}/trigger-update`, {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Aggiornamento avviato');
            setTimeout(loadAgents, 5000);
        } else {
            alert('Errore: ' + (data.error || data.message));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function updateAllAgents() {
    if (!confirm('Aggiornare tutti gli agent?')) return;
    
    try {
        const response = await fetch('/api/v1/agents/update-all', {
            method: 'POST'
        });
        
        const data = await response.json();
        alert(`Aggiornati: ${data.total_updated}\nFalliti: ${data.total_failed}`);
        setTimeout(loadAgents, 5000);
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// ==========================================
// VERIFICA VERSIONE AGENT
// ==========================================

async function verifyAgentVersion(agentId, agentName) {
    try {
        const response = await fetch(`/api/v1/agents/${agentId}/verify-version`);
        const data = await response.json();
        
        if (data.success) {
            let message = `ðŸ“‹ Verifica Agent: ${agentName}\n\n`;
            message += `ðŸ”Œ Online: ${data.agent_online ? 'âœ… SÃ¬' : 'âŒ No'}\n`;
            message += `ðŸ“¦ Versione DB: ${data.db_version}\n`;
            message += `ðŸ”„ Versione Reale: ${data.real_version}\n`;
            message += `ðŸ†• Ultima Disponibile: ${data.latest_version}\n\n`;
            
            if (data.needs_update) {
                message += `âš ï¸ AGGIORNAMENTO DISPONIBILE`;
            } else if (data.version_match) {
                message += `âœ… Versione aggiornata e confermata`;
            } else {
                message += `âš ï¸ Versione DB non corrispondente (aggiornato a ${data.real_version})`;
            }
            
            alert(message);
            loadAgents(); // Ricarica per aggiornare versioni
        } else {
            alert(`âŒ Verifica fallita per ${agentName}\n\n${data.error}`);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// ==========================================
// SERVER UPDATE SYSTEM
// ==========================================

async function loadServerVersion() {
    try {
        const response = await fetch('/api/v1/agents/server/version');
        const data = await response.json();
        
        document.getElementById('server-version').textContent = `v${data.version}`;
        document.getElementById('agent-version').textContent = `v${data.agent_version}`;
    } catch (e) {
        document.getElementById('server-version').textContent = 'Errore';
    }
}

async function checkServerUpdate() {
    const container = document.getElementById('update-status-container');
    const upToDateContainer = document.getElementById('up-to-date-container');
    
    try {
        container.style.display = 'none';
        upToDateContainer.style.display = 'none';
        
        const response = await fetch('/api/v1/agents/server/check-update');
        const data = await response.json();
        
        if (data.success) {
            if (data.needs_update) {
                container.style.display = 'flex';
                document.getElementById('latest-version').textContent = `v${data.latest_version}`;
                
                if (data.release_name) {
                    alert(`ðŸ†• Aggiornamento disponibile!\n\n` +
                          `Versione attuale: v${data.current_version}\n` +
                          `Nuova versione: v${data.latest_version}\n` +
                          `Nome: ${data.release_name}\n` +
                          `Data: ${data.release_date ? new Date(data.release_date).toLocaleDateString('it-IT') : 'N/A'}\n\n` +
                          `Note:\n${data.changelog || 'Nessuna nota'}`);
                }
            } else {
                upToDateContainer.style.display = 'flex';
                alert(`âœ… Server aggiornato\n\nVersione: v${data.current_version}`);
            }
        } else {
            alert('âš ï¸ Impossibile verificare aggiornamenti: ' + data.error);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function updateServer() {
    if (!confirm('Aggiornare il server DaDude?\n\nQuesto eseguirÃ  git pull e potrebbe richiedere un riavvio.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/v1/agents/server/update', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            if (data.already_up_to_date) {
                alert('âœ… Server giÃ  aggiornato');
            } else {
                alert(`âœ… Server aggiornato!\n\n${data.output}\n\n` +
                      (data.needs_restart ? 'âš ï¸ Riavvio necessario per applicare le modifiche.' : ''));
                
                if (data.needs_restart) {
                    if (confirm('Vuoi riavviare il server ora?')) {
                        await restartServer();
                    }
                }
            }
        } else {
            alert('âŒ Aggiornamento fallito:\n\n' + data.error);
        }
        
        loadServerVersion();
        
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function restartServer() {
    try {
        const response = await fetch('/api/v1/agents/server/restart', {
            method: 'POST'
        });
        const data = await response.json();
        
        alert(data.message + (data.command ? `\n\nComando: ${data.command}` : ''));
    } catch (e) {
        // Il server potrebbe non rispondere durante il riavvio
        alert('Comando di riavvio inviato. La pagina si ricaricherÃ  tra 5 secondi...');
        setTimeout(() => window.location.reload(), 5000);
    }
}

async function viewRecentCommits() {
    try {
        const response = await fetch('/api/v1/agents/server/commits');
        const data = await response.json();
        
        if (data.success) {
            let message = 'ðŸ“œ Ultimi Commit su GitHub\n\n';
            data.commits.forEach((c, i) => {
                message += `${i+1}. [${c.sha}] ${c.message}\n   ${c.author} - ${new Date(c.date).toLocaleDateString('it-IT')}\n\n`;
            });
            alert(message);
        } else {
            alert('Errore: ' + data.error);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// Carica al load
document.addEventListener('DOMContentLoaded', () => {
    loadAgents();
    loadServerVersion();
});
</script>
{% endblock %}

