{% extends "base.html" %}

{% block title %}Gestione Agent - DaDude{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-robot"></i> Gestione Agent</h2>
        <button class="btn btn-outline-primary" onclick="loadAgents()">
            <i class="bi bi-arrow-clockwise"></i> Aggiorna
        </button>
    </div>

    <!-- Server Update Status -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-server"></i> Stato Server DaDude
            </h5>
            <div class="btn-group">
                <button class="btn btn-sm btn-light" onclick="checkServerUpdate()">
                    <i class="bi bi-cloud-arrow-down"></i> Verifica Aggiornamenti
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="server-status">
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-box-seam fs-2 me-3 text-primary"></i>
                            <div>
                                <small class="text-muted">Versione Server</small>
                                <h5 class="mb-0" id="server-version">Caricamento...</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-robot fs-2 me-3 text-info"></i>
                            <div>
                                <small class="text-muted">Versione Agent</small>
                                <h5 class="mb-0" id="agent-version">Caricamento...</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center" id="update-status-container" style="display: none;">
                            <i class="bi bi-arrow-up-circle-fill fs-2 me-3 text-success"></i>
                            <div>
                                <small class="text-muted">Aggiornamento Disponibile</small>
                                <h5 class="mb-0" id="latest-version">-</h5>
                                <button class="btn btn-sm btn-success mt-1" onclick="updateServer()">
                                    <i class="bi bi-download"></i> Aggiorna Server
                                </button>
                            </div>
                        </div>
                        <div id="up-to-date-container" style="display: none;">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-check-circle-fill fs-2 me-3 text-success"></i>
                                <div>
                                    <small class="text-muted">Stato</small>
                                    <h5 class="mb-0 text-success">Aggiornato</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent in attesa di approvazione -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="bi bi-hourglass-split"></i> Agent in Attesa di Approvazione
                <span id="pending-count" class="badge bg-dark ms-2">0</span>
            </h5>
        </div>
        <div class="card-body">
            <div id="pending-agents">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-search fs-1"></i>
                    <p class="mt-2">Caricamento...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Attivi -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="bi bi-check-circle"></i> Agent Attivi
                <span id="active-count" class="badge bg-light text-dark ms-2">0</span>
            </h5>
        </div>
        <div class="card-body">
            <div id="active-agents">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-search fs-1"></i>
                    <p class="mt-2">Caricamento...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Outdated -->
    <div class="card">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-arrow-up-circle"></i> Aggiornamenti Disponibili
                <span id="outdated-count" class="badge bg-light text-dark ms-2">0</span>
            </h5>
            <button class="btn btn-sm btn-light" onclick="updateAllAgents()" id="update-all-btn" style="display: none;">
                <i class="bi bi-download"></i> Aggiorna Tutti
            </button>
        </div>
        <div class="card-body">
            <div id="outdated-agents">
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-lg fs-1"></i>
                    <p class="mt-2">Tutti gli agent sono aggiornati</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Approva Agent -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approva Agent</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Agent</label>
                    <input type="text" class="form-control" id="approve-agent-name" readonly>
                    <input type="hidden" id="approve-agent-id">
                </div>
                <div class="mb-3">
                    <label class="form-label">Indirizzo IP</label>
                    <input type="text" class="form-control" id="approve-agent-ip" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Assegna a Cliente *</label>
                    <select class="form-select" id="approve-customer-id" required>
                        <option value="">-- Seleziona Cliente --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-success" onclick="confirmApprove()">
                    <i class="bi bi-check-lg"></i> Approva
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Riassegna Agent -->
<div class="modal fade" id="reassignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-left-right"></i> Riassegna Agent</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Agent</label>
                    <input type="text" class="form-control" id="reassign-agent-name" readonly>
                    <input type="hidden" id="reassign-agent-id">
                </div>
                <div class="mb-3">
                    <label class="form-label">Cliente Attuale</label>
                    <input type="text" class="form-control" id="reassign-current-customer" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Nuovo Cliente *</label>
                    <select class="form-select" id="reassign-customer-id" required>
                        <option value="">-- Seleziona Nuovo Cliente --</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Oppure</label>
                    <button type="button" class="btn btn-outline-warning w-100" onclick="unassignAgent()">
                        <i class="bi bi-x-circle"></i> Dissocia da Cliente (rende pending)
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" onclick="confirmReassign()">
                    <i class="bi bi-check-lg"></i> Riassegna
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Console Remota -->
<div class="modal fade" id="consoleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="bi bi-terminal"></i> Console Remota - <span id="console-agent-name"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="console-agent-id">
                
                <!-- Opzioni target -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Esegui su</label>
                        <select class="form-select form-select-sm" id="console-target-type" onchange="toggleSSHOptions()">
                            <option value="agent">Agent locale</option>
                            <option value="ssh">Host remoto (SSH)</option>
                        </select>
                    </div>
                    <div class="col-md-3" id="ssh-host-group" style="display:none;">
                        <label class="form-label">Host</label>
                        <input type="text" class="form-control form-control-sm" id="console-ssh-host" placeholder="192.168.1.100">
                    </div>
                    <div class="col-md-2" id="ssh-user-group" style="display:none;">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control form-control-sm" id="console-ssh-user" value="root">
                    </div>
                    <div class="col-md-2" id="ssh-pass-group" style="display:none;">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control form-control-sm" id="console-ssh-pass" placeholder="(opzionale)">
                    </div>
                    <div class="col-md-2" id="ssh-port-group" style="display:none;">
                        <label class="form-label">Porta</label>
                        <input type="number" class="form-control form-control-sm" id="console-ssh-port" value="22">
                    </div>
                </div>
                
                <!-- Comando -->
                <div class="mb-3">
                    <label class="form-label">Comando</label>
                    <div class="input-group">
                        <span class="input-group-text bg-dark text-success">$</span>
                        <input type="text" class="form-control font-monospace" id="console-command" 
                               placeholder="es: uptime, df -h, ip addr, ping -c 3 8.8.8.8"
                               onkeypress="if(event.key==='Enter')execConsoleCommand()">
                        <button class="btn btn-success" onclick="execConsoleCommand()">
                            <i class="bi bi-play-fill"></i> Esegui
                        </button>
                    </div>
                </div>
                
                <!-- Comandi rapidi -->
                <div class="mb-3">
                    <label class="form-label">Comandi rapidi</label>
                    <div class="btn-group btn-group-sm flex-wrap">
                        <button class="btn btn-outline-secondary" onclick="setCommand('uptime')">uptime</button>
                        <button class="btn btn-outline-secondary" onclick="setCommand('df -h')">df -h</button>
                        <button class="btn btn-outline-secondary" onclick="setCommand('free -m')">free -m</button>
                        <button class="btn btn-outline-secondary" onclick="setCommand('ip addr')">ip addr</button>
                        <button class="btn btn-outline-secondary" onclick="setCommand('ps aux --sort=-%mem | head -20')">top mem</button>
                        <button class="btn btn-outline-secondary" onclick="setCommand('docker ps')">docker ps</button>
                        <button class="btn btn-outline-secondary" onclick="setCommand('systemctl status')">systemctl</button>
                        <button class="btn btn-outline-secondary" onclick="setCommand('cat /etc/os-release')">OS info</button>
                        <button class="btn btn-outline-secondary" onclick="setCommand('netstat -tlnp')">netstat</button>
                        <button class="btn btn-outline-secondary" onclick="setCommand('ls -la')">ls -la</button>
                    </div>
                </div>
                
                <!-- Output -->
                <div class="mb-3">
                    <label class="form-label">Output</label>
                    <pre id="console-output" class="bg-dark text-light p-3 rounded" 
                         style="min-height: 300px; max-height: 500px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px;">
In attesa di comandi...
                    </pre>
                </div>
                
                <!-- Storico -->
                <div class="mb-0">
                    <label class="form-label">Storico comandi</label>
                    <div id="console-history" class="d-flex flex-wrap gap-1">
                        <span class="text-muted small">Nessun comando eseguito</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="clearConsole()">
                    <i class="bi bi-trash"></i> Pulisci Output
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<script>
let customers = [];

async function loadAgents() {
    await Promise.all([
        loadPendingAgents(),
        loadActiveAgents(),
        loadOutdatedAgents(),
        loadCustomers()
    ]);
}

async function loadCustomers() {
    try {
        const response = await fetch('/api/v1/customers');
        if (response.ok) {
            const data = await response.json();
            customers = data.customers || data;
            
            // Popola dropdown
            const select = document.getElementById('approve-customer-id');
            select.innerHTML = '<option value="">-- Seleziona Cliente --</option>';
            customers.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }
    } catch (e) {
        console.error('Error loading customers:', e);
    }
}

async function loadPendingAgents() {
    const container = document.getElementById('pending-agents');
    
    try {
        const response = await fetch('/api/v1/agents/pending');
        if (!response.ok) throw new Error('Failed to load pending agents');
        
        const data = await response.json();
        document.getElementById('pending-count').textContent = data.total;
        
        if (data.total === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-circle fs-1"></i>
                    <p class="mt-2">Nessun agent in attesa di approvazione</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Indirizzo</th>
                        <th>Tipo</th>
                        <th>Versione</th>
                        <th>Registrato</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.agents.map(a => `
                        <tr>
                            <td><strong>${a.name}</strong></td>
                            <td><code>${a.address}</code></td>
                            <td><span class="badge bg-secondary">${a.agent_type || 'docker'}</span></td>
                            <td>${a.version || 'N/A'}</td>
                            <td>${a.created_at ? new Date(a.created_at).toLocaleString() : 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="showApproveModal('${a.id}', '${a.name}', '${a.address}')">
                                    <i class="bi bi-check-lg"></i> Approva
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="rejectAgent('${a.id}')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
    } catch (e) {
        container.innerHTML = `
            <div class="alert alert-danger">
                Errore nel caricamento: ${e.message}
            </div>
        `;
    }
}

async function loadActiveAgents() {
    const container = document.getElementById('active-agents');

    try {
        // Carica tutti gli agent assegnati dai clienti
        const response = await fetch('/api/v1/customers');
        if (!response.ok) throw new Error('Failed to load customers');

        const data = await response.json();
        const customers = data.customers || data; // Supporta entrambi i formati
        let allAgents = [];

        for (const customer of customers) {
            const agentsResp = await fetch(`/api/v1/customers/${customer.id}/agents`);
            if (agentsResp.ok) {
                const agents = await agentsResp.json();
                agents.forEach(a => {
                    allAgents.push({...a, customer_name: customer.name, customer_id: customer.id});
                });
            }
        }

        // Ottieni lista agent connessi via WebSocket (real-time)
        let wsConnected = new Set();
        let wsConnectedByName = new Set();
        try {
            const wsResp = await fetch('/api/v1/admin/agents/ws/connected');
            if (wsResp.ok) {
                const wsData = await wsResp.json();
                wsData.agents.forEach(wsAgent => {
                    wsConnected.add(wsAgent.agent_id);
                    // Extract name from agent_id (format: "agent-{name}" or "agent-{name}-{number}")
                    const match = wsAgent.agent_id.match(/^agent-(.+?)(?:-\d+)?$/);
                    if (match) {
                        wsConnectedByName.add(match[1]);
                    }
                });
                console.log(`WebSocket connected agents: ${wsConnected.size}`, Array.from(wsConnected));
                console.log(`WebSocket connected names: ${wsConnectedByName.size}`, Array.from(wsConnectedByName));
            }
        } catch (e) {
            console.warn('Could not fetch WebSocket status:', e);
        }

        // Aggiorna stato connessione real-time per ogni agent
        // Prima identifica i Docker agents connessi per ogni cliente
        const connectedDockerByCustomer = {};
        allAgents.forEach(a => {
            if (a.agent_type === 'docker' && wsConnectedByName.has(a.name)) {
                a.ws_connected = true;
                if (!connectedDockerByCustomer[a.customer_id]) {
                    connectedDockerByCustomer[a.customer_id] = a.name;
                }
            } else if (a.agent_type === 'docker') {
                a.ws_connected = false;
            }
        });
        
        // Per MikroTik, verifica se raggiungibili via Docker agent dello stesso cliente
        allAgents.forEach(a => {
            if (a.agent_type === 'mikrotik' || !a.agent_type) {
                const bridgeAgent = connectedDockerByCustomer[a.customer_id];
                if (bridgeAgent) {
                    a.reachable = true;
                    a.reachable_via = bridgeAgent;
                } else {
                    a.reachable = false;
                }
            }
        });

        document.getElementById('active-count').textContent = allAgents.length;
        
        if (allAgents.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-robot fs-1"></i>
                    <p class="mt-2">Nessun agent attivo</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Cliente</th>
                        <th>Indirizzo</th>
                        <th>Tipo</th>
                        <th>Stato</th>
                        <th>Versione</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    ${allAgents.map(a => `
                        <tr>
                            <td><strong>${a.name}</strong></td>
                            <td><a href="/customers/${a.customer_id}">${a.customer_name}</a></td>
                            <td><code>${a.address}</code></td>
                            <td><span class="badge ${a.agent_type === 'docker' ? 'bg-info' : 'bg-primary'}">${a.agent_type || 'mikrotik'}</span></td>
                            <td>
                                ${a.agent_type === 'docker' 
                                    ? `<span class="badge ${a.ws_connected ? 'bg-success' : 'bg-danger'}">
                                        ${a.ws_connected ? '<i class="bi bi-wifi"></i> Online' : '<i class="bi bi-x-circle"></i> Offline'}
                                       </span>`
                                    : (a.reachable 
                                        ? `<span class="badge bg-info"><i class="bi bi-arrow-right-circle"></i> Raggiungibile</span>
                                           <small class="text-muted d-block">via ${a.reachable_via}</small>`
                                        : `<span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> Non raggiungibile</span>`)
                                }
                            </td>
                            <td>${a.version || 'N/A'}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-dark" onclick="showConsoleModal('${a.id}', '${a.name}')" title="Console remota">
                                        <i class="bi bi-terminal"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="showReassignModal('${a.id}', '${a.name}', '${a.customer_id}')" title="Riassegna a cliente">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="testAgent('${a.id}', '${a.address}', ${a.agent_api_port || 8080})" title="Test connessione">
                                        <i class="bi bi-broadcast"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="verifyAgentVersion('${a.id}', '${a.name}')" title="Verifica versione">
                                        <i class="bi bi-search"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="restartAgent('${a.id}')" title="Riavvia">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteAgent('${a.id}', '${a.name}')" title="Elimina">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
    } catch (e) {
        container.innerHTML = `
            <div class="alert alert-danger">
                Errore nel caricamento: ${e.message}
            </div>
        `;
    }
}

async function loadOutdatedAgents() {
    const container = document.getElementById('outdated-agents');
    
    try {
        const response = await fetch('/api/v1/agents/outdated');
        if (!response.ok) throw new Error('Failed to load outdated agents');
        
        const data = await response.json();
        document.getElementById('outdated-count').textContent = data.outdated_count;
        
        if (data.outdated_count === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-lg fs-1"></i>
                    <p class="mt-2">Tutti gli agent sono aggiornati (v${data.latest_version})</p>
                </div>
            `;
            document.getElementById('update-all-btn').style.display = 'none';
            return;
        }
        
        document.getElementById('update-all-btn').style.display = 'block';
        
        container.innerHTML = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Indirizzo</th>
                        <th>Versione Attuale</th>
                        <th>Versione Disponibile</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.outdated_agents.map(a => `
                        <tr>
                            <td><strong>${a.name}</strong></td>
                            <td><code>${a.address}</code></td>
                            <td><span class="badge bg-warning text-dark">${a.current_version}</span></td>
                            <td><span class="badge bg-success">${a.latest_version}</span></td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-primary" onclick="updateAgent('${a.id}')">
                                        <i class="bi bi-download"></i> Aggiorna
                                    </button>
                                    <button class="btn btn-info" onclick="verifyAgentVersion('${a.id}', '${a.name}')" title="Verifica versione dopo update">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
    } catch (e) {
        container.innerHTML = `
            <div class="alert alert-danger">
                Errore nel caricamento: ${e.message}
            </div>
        `;
    }
}

function showApproveModal(agentId, agentName, agentIp) {
    document.getElementById('approve-agent-id').value = agentId;
    document.getElementById('approve-agent-name').value = agentName;
    document.getElementById('approve-agent-ip').value = agentIp;
    
    new bootstrap.Modal(document.getElementById('approveModal')).show();
}

async function confirmApprove() {
    const agentId = document.getElementById('approve-agent-id').value;
    const customerId = document.getElementById('approve-customer-id').value;
    
    if (!customerId) {
        alert('Seleziona un cliente');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/agents/${agentId}/approve?customer_id=${customerId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('approveModal')).hide();
            alert('Agent approvato con successo!');
            loadAgents();
        } else {
            const data = await response.json();
            alert('Errore: ' + (data.detail || 'Approvazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function rejectAgent(agentId) {
    if (!confirm('Eliminare questo agent in attesa?')) return;
    
    try {
        const response = await fetch(`/api/v1/customers/agents/${agentId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadAgents();
        } else {
            alert('Errore nella cancellazione');
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function deleteAgent(agentId, agentName) {
    if (!confirm(`âš ï¸ Eliminare l'agent "${agentName}"?\n\nL'agent verrÃ  rimosso dal sistema.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/customers/agents/${agentId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Agent eliminato con successo');
            loadAgents();
        } else {
            const error = await response.json();
            alert('Errore: ' + (error.detail || 'Eliminazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

function showReassignModal(agentId, agentName, currentCustomerId) {
    document.getElementById('reassign-agent-id').value = agentId;
    document.getElementById('reassign-agent-name').value = agentName;
    
    // Trova nome cliente attuale
    const currentCustomer = customers.find(c => c.id === currentCustomerId);
    document.getElementById('reassign-current-customer').value = currentCustomer ? currentCustomer.name : 'N/A';
    
    // Popola dropdown clienti (escludi cliente attuale)
    const select = document.getElementById('reassign-customer-id');
    select.innerHTML = '<option value="">-- Seleziona Nuovo Cliente --</option>';
    customers.forEach(c => {
        if (c.id !== currentCustomerId) {
            select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        }
    });
    
    new bootstrap.Modal(document.getElementById('reassignModal')).show();
}

async function confirmReassign() {
    const agentId = document.getElementById('reassign-agent-id').value;
    const newCustomerId = document.getElementById('reassign-customer-id').value;
    
    if (!newCustomerId) {
        alert('Seleziona un cliente');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/customers/agents/${agentId}/reassign?new_customer_id=${newCustomerId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('reassignModal')).hide();
            alert('Agent riassegnato con successo!');
            loadAgents();
        } else {
            const data = await response.json();
            alert('Errore: ' + (data.detail || 'Riassegnazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function unassignAgent() {
    const agentId = document.getElementById('reassign-agent-id').value;
    const agentName = document.getElementById('reassign-agent-name').value;
    
    if (!confirm(`Dissociare l'agent "${agentName}" dal cliente?\n\nL'agent tornerÃ  in stato "pending" e dovrÃ  essere riassegnato.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/customers/agents/${agentId}/unassign`, {
            method: 'POST'
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('reassignModal')).hide();
            alert('Agent dissociato. Ora appare nella lista "In Attesa di Approvazione".');
            loadAgents();
        } else {
            const data = await response.json();
            alert('Errore: ' + (data.detail || 'Dissociazione fallita'));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// ==========================================
// CONSOLE REMOTA
// ==========================================

let commandHistory = [];

function showConsoleModal(agentId, agentName) {
    document.getElementById('console-agent-id').value = agentId;
    document.getElementById('console-agent-name').textContent = agentName;
    document.getElementById('console-command').value = '';
    document.getElementById('console-output').textContent = `Console remota per agent: ${agentName}\nIn attesa di comandi...\n`;
    
    new bootstrap.Modal(document.getElementById('consoleModal')).show();
    
    // Focus sul campo comando
    setTimeout(() => document.getElementById('console-command').focus(), 500);
}

function toggleSSHOptions() {
    const targetType = document.getElementById('console-target-type').value;
    const show = targetType === 'ssh';
    
    document.getElementById('ssh-host-group').style.display = show ? 'block' : 'none';
    document.getElementById('ssh-user-group').style.display = show ? 'block' : 'none';
    document.getElementById('ssh-pass-group').style.display = show ? 'block' : 'none';
    document.getElementById('ssh-port-group').style.display = show ? 'block' : 'none';
}

function setCommand(cmd) {
    document.getElementById('console-command').value = cmd;
    document.getElementById('console-command').focus();
}

function clearConsole() {
    document.getElementById('console-output').textContent = 'Console pulita.\n';
}

async function execConsoleCommand() {
    const agentId = document.getElementById('console-agent-id').value;
    const command = document.getElementById('console-command').value.trim();
    const targetType = document.getElementById('console-target-type').value;
    
    if (!command) {
        alert('Inserisci un comando');
        return;
    }
    
    const output = document.getElementById('console-output');
    const timestamp = new Date().toLocaleTimeString();
    
    // Aggiungi prompt
    if (targetType === 'ssh') {
        const host = document.getElementById('console-ssh-host').value;
        output.textContent += `\n[${timestamp}] ${host}$ ${command}\n`;
    } else {
        output.textContent += `\n[${timestamp}] agent$ ${command}\n`;
    }
    output.textContent += 'â³ Esecuzione in corso...\n';
    output.scrollTop = output.scrollHeight;
    
    try {
        // Costruisci URL usando endpoint proxy per Admin UI
        let url = `/api/v1/admin/agents/${agentId}/exec?command=${encodeURIComponent(command)}`;

        if (targetType === 'ssh') {
            const host = document.getElementById('console-ssh-host').value;
            const user = document.getElementById('console-ssh-user').value || 'root';
            const pass = document.getElementById('console-ssh-pass').value;
            const port = document.getElementById('console-ssh-port').value || 22;

            if (!host) {
                output.textContent += 'âŒ Errore: Specificare host remoto\n';
                return;
            }

            url += `&target_host=${encodeURIComponent(host)}`;
            url += `&username=${encodeURIComponent(user)}`;
            url += `&port=${port}`;
            if (pass) url += `&password=${encodeURIComponent(pass)}`;
        }

        const response = await fetch(url, { method: 'POST' });
        const data = await response.json();
        
        // Rimuovi "Esecuzione in corso..."
        output.textContent = output.textContent.replace('â³ Esecuzione in corso...\n', '');
        
        if (data.success) {
            if (data.stdout) {
                output.textContent += data.stdout;
                if (!data.stdout.endsWith('\n')) output.textContent += '\n';
            }
            if (data.stderr) {
                output.textContent += `âš ï¸ STDERR:\n${data.stderr}\n`;
            }
            output.textContent += `âœ… Exit code: ${data.exit_code}\n`;
        } else {
            output.textContent += `âŒ Errore: ${data.error || 'Comando fallito'}\n`;
        }
        
        // Aggiungi a storico
        addToHistory(command);
        
        // Pulisci campo comando
        document.getElementById('console-command').value = '';
        
    } catch (e) {
        output.textContent = output.textContent.replace('â³ Esecuzione in corso...\n', '');
        output.textContent += `âŒ Errore: ${e.message}\n`;
    }
    
    output.scrollTop = output.scrollHeight;
}

function addToHistory(cmd) {
    if (!commandHistory.includes(cmd)) {
        commandHistory.unshift(cmd);
        if (commandHistory.length > 10) commandHistory.pop();
    }
    
    const historyDiv = document.getElementById('console-history');
    historyDiv.innerHTML = commandHistory.map(c => 
        `<button class="btn btn-sm btn-outline-dark" onclick="setCommand('${c.replace(/'/g, "\\'")}')">${c.length > 30 ? c.substring(0,30)+'...' : c}</button>`
    ).join('');
}

async function testAgent(agentId, address, port) {
    try {
        // Usa l'API del server per verificare (supporta WebSocket e HTTP)
        // Use admin proxy endpoint for cross-process WebSocket Hub access
        const response = await fetch(`/api/v1/admin/agents/${agentId}/verify-version`);
        const data = await response.json();
        
        if (data.success && data.agent_online) {
            let connType = data.connection_type === 'websocket' ? 'ðŸ”Œ WebSocket' : 'ðŸŒ HTTP';
            alert(`âœ… Agent Online!\n\n` +
                  `Nome: ${data.agent_name}\n` +
                  `Versione: ${data.real_version}\n` +
                  `Connessione: ${connType}\n` +
                  (data.ws_agent_id ? `WS ID: ${data.ws_agent_id}` : `URL: http://${address}:${port}`));
        } else {
            alert(`âŒ Agent Offline\n\n${data.error || 'Non raggiungibile'}`);
        }
    } catch (e) {
        alert('âŒ Errore: ' + e.message);
    }
}

async function restartAgent(agentId) {
    if (!confirm('Riavviare questo agent?')) return;
    
    try {
        const response = await fetch(`/api/v1/agents/${agentId}/restart`, {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('Comando di riavvio inviato');
        } else {
            alert('Errore nell\'invio del comando');
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function updateAgent(agentId) {
    try {
        const response = await fetch(`/api/v1/agents/${agentId}/trigger-update`, {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Aggiornamento avviato');
            setTimeout(loadAgents, 5000);
        } else {
            alert('Errore: ' + (data.error || data.message));
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function updateAllAgents() {
    if (!confirm('Aggiornare tutti gli agent?')) return;
    
    try {
        const response = await fetch('/api/v1/agents/update-all', {
            method: 'POST'
        });
        
        const data = await response.json();
        alert(`Aggiornati: ${data.total_updated}\nFalliti: ${data.total_failed}`);
        setTimeout(loadAgents, 5000);
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// ==========================================
// VERIFICA VERSIONE AGENT
// ==========================================

async function verifyAgentVersion(agentId, agentName) {
    try {
        // Use admin proxy endpoint for cross-process WebSocket Hub access
        const response = await fetch(`/api/v1/admin/agents/${agentId}/verify-version`);
        const data = await response.json();
        
        if (data.success) {
            let message = `ðŸ“‹ Verifica Agent: ${agentName}\n\n`;
            message += `ðŸ”Œ Online: ${data.agent_online ? 'âœ… SÃ¬' : 'âŒ No'}\n`;
            message += `ðŸ“¦ Versione DB: ${data.db_version}\n`;
            message += `ðŸ”„ Versione Reale: ${data.real_version}\n`;
            message += `ðŸ†• Ultima Disponibile: ${data.latest_version}\n\n`;
            
            if (data.needs_update) {
                message += `âš ï¸ AGGIORNAMENTO DISPONIBILE`;
            } else if (data.version_match) {
                message += `âœ… Versione aggiornata e confermata`;
            } else {
                message += `âš ï¸ Versione DB non corrispondente (aggiornato a ${data.real_version})`;
            }
            
            alert(message);
            loadAgents(); // Ricarica per aggiornare versioni
        } else {
            alert(`âŒ Verifica fallita per ${agentName}\n\n${data.error}`);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// ==========================================
// SERVER UPDATE SYSTEM
// ==========================================

async function loadServerVersion() {
    try {
        const response = await fetch('/api/v1/agents/server/version');
        const data = await response.json();
        
        document.getElementById('server-version').textContent = `v${data.version}`;
        document.getElementById('agent-version').textContent = `v${data.agent_version}`;
    } catch (e) {
        document.getElementById('server-version').textContent = 'Errore';
    }
}

async function checkServerUpdate() {
    const container = document.getElementById('update-status-container');
    const upToDateContainer = document.getElementById('up-to-date-container');
    
    try {
        container.style.display = 'none';
        upToDateContainer.style.display = 'none';
        
        const response = await fetch('/api/v1/agents/server/check-update');
        const data = await response.json();
        
        if (data.success) {
            if (data.needs_update) {
                container.style.display = 'flex';
                document.getElementById('latest-version').textContent = `v${data.latest_version}`;
                
                if (data.release_name) {
                    alert(`ðŸ†• Aggiornamento disponibile!\n\n` +
                          `Versione attuale: v${data.current_version}\n` +
                          `Nuova versione: v${data.latest_version}\n` +
                          `Nome: ${data.release_name}\n` +
                          `Data: ${data.release_date ? new Date(data.release_date).toLocaleDateString('it-IT') : 'N/A'}\n\n` +
                          `Note:\n${data.changelog || 'Nessuna nota'}`);
                }
            } else {
                upToDateContainer.style.display = 'flex';
                alert(`âœ… Server aggiornato\n\nVersione: v${data.current_version}`);
            }
        } else {
            alert('âš ï¸ Impossibile verificare aggiornamenti: ' + data.error);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function updateServer() {
    if (!confirm('Aggiornare il server DaDude?\n\nQuesto eseguirÃ  git pull e potrebbe richiedere un riavvio.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/v1/agents/server/update', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            if (data.already_up_to_date) {
                alert('âœ… Server giÃ  aggiornato');
            } else {
                alert(`âœ… Server aggiornato!\n\n${data.output}\n\n` +
                      (data.needs_restart ? 'âš ï¸ Riavvio necessario per applicare le modifiche.' : ''));
                
                if (data.needs_restart) {
                    if (confirm('Vuoi riavviare il server ora?')) {
                        await restartServer();
                    }
                }
            }
        } else {
            alert('âŒ Aggiornamento fallito:\n\n' + data.error);
        }
        
        loadServerVersion();
        
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

async function restartServer() {
    try {
        const response = await fetch('/api/v1/agents/server/restart', {
            method: 'POST'
        });
        const data = await response.json();
        
        alert(data.message + (data.command ? `\n\nComando: ${data.command}` : ''));
    } catch (e) {
        // Il server potrebbe non rispondere durante il riavvio
        alert('Comando di riavvio inviato. La pagina si ricaricherÃ  tra 5 secondi...');
        setTimeout(() => window.location.reload(), 5000);
    }
}

async function viewRecentCommits() {
    try {
        const response = await fetch('/api/v1/agents/server/commits');
        const data = await response.json();
        
        if (data.success) {
            let message = 'ðŸ“œ Ultimi Commit su GitHub\n\n';
            data.commits.forEach((c, i) => {
                message += `${i+1}. [${c.sha}] ${c.message}\n   ${c.author} - ${new Date(c.date).toLocaleDateString('it-IT')}\n\n`;
            });
            alert(message);
        } else {
            alert('Errore: ' + data.error);
        }
    } catch (e) {
        alert('Errore: ' + e.message);
    }
}

// Carica al load
document.addEventListener('DOMContentLoaded', () => {
    loadAgents();
    loadServerVersion();
});
</script>
{% endblock %}

